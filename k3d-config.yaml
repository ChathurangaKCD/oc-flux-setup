# k3d cluster configuration for OpenChoreo on VM with limited port exposure
#
# NOTE: This config is RECONSTRUCTED from the running cluster.
# Source of truth: kubectl get node k3d-openchoreo-server-0 -o jsonpath="{.metadata.annotations.k3s\.io/node-args}"
#
# ORIGINAL k3s args (from node annotation):
#   ["server", "--tls-san", "host.k3d.internal",
#    "--kubelet-arg", "eviction-hard=imagefs.available<1%,nodefs.available<1%",
#    "--kubelet-arg", "eviction-minimum-reclaim=imagefs.available=1%,nodefs.available=1%",
#    "--tls-san", "0.0.0.0", "--tls-san", "k3d-openchoreo-serverlb"]
#
# Key observations:
#   - Ports exposed on VM: 8080, 9080, 6550 (from: ss -tlnp)
#   - Traefik was NOT disabled in original (--disable=traefik missing)
#   - Traefik had to be deleted manually: kubectl delete deployment traefik -n kube-system
#   - Cluster created: 2025-12-03 (49+ days old)
#
# To recreate the cluster:
#   k3d cluster delete openchoreo
#   k3d cluster create --config k3d-config.yaml
#
# After cluster creation, bootstrap Flux:
#   flux bootstrap github --owner=<owner> --repository=oc-flux-setup --path=clusters/openchoreo-dev

apiVersion: k3d.io/v1alpha5
kind: Simple
metadata:
  name: openchoreo
image: rancher/k3s:v1.32.9-k3s1
servers: 1
agents: 0
kubeAPI:
  hostPort: "6550"

# VM only exposes ports 8080 and 9080 externally
ports:
  # Control Plane HTTP (UI, API, Thunder)
  # Maps host:8080 -> cluster:80 (gateway-default LoadBalancer)
  - port: 8080:80
    nodeFilters:
      - loadbalancer
  # Data Plane HTTP (deployed workloads)
  # Maps host:9080 -> cluster:19080 (data-plane gateway-default LoadBalancer)
  - port: 9080:19080
    nodeFilters:
      - loadbalancer

options:
  k3s:
    extraArgs:
      # Original args from node annotation
      - arg: "--tls-san=host.k3d.internal"
        nodeFilters:
          - server:*
      - arg: "--tls-san=0.0.0.0"
        nodeFilters:
          - server:*
      - arg: "--tls-san=k3d-openchoreo-serverlb"
        nodeFilters:
          - server:*
      - arg: "--kubelet-arg=eviction-hard=imagefs.available<1%,nodefs.available<1%"
        nodeFilters:
          - server:*
      - arg: "--kubelet-arg=eviction-minimum-reclaim=imagefs.available=1%,nodefs.available=1%"
        nodeFilters:
          - server:*
      # RECOMMENDED: Disable Traefik (was NOT in original, had to delete manually)
      - arg: "--disable=traefik"
        nodeFilters:
          - server:*
