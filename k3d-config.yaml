# k3d cluster configuration for OpenChoreo on VM
# Based on: openchoreo3/install/k3d/single-cluster/config.yaml
# VM-specific change: Only ports 8080 and 9080 are exposed externally

apiVersion: k3d.io/v1alpha5
kind: Simple
metadata:
  name: openchoreo
image: rancher/k3s:v1.32.9-k3s1
servers: 1
agents: 0
kubeAPI:
  hostPort: "6550"

# VM only exposes ports 8080 and 9080 externally
# Other planes are accessible only within the cluster
ports:
  # Control Plane HTTP (UI, API, Thunder)
  # Maps host:8080 -> cluster:80 (gateway-default LoadBalancer)
  - port: 8080:80
    nodeFilters:
      - loadbalancer
  # Data Plane HTTP (deployed workloads)
  # Maps host:9080 -> cluster:19080 (data-plane gateway-default LoadBalancer)
  # Note: Official config uses 19080:19080, VM remaps to 9080:19080
  - port: 9080:19080
    nodeFilters:
      - loadbalancer

options:
  k3s:
    extraArgs:
      # Add host.k3d.internal to API server TLS certificate SANs.
      # This allows consistent DataPlane configuration across single and multi-cluster setups
      # where Control Plane pods can access the API server via host.k3d.internal:6550
      - arg: "--tls-san=host.k3d.internal"
        nodeFilters:
          - server:*
      # Configure kubelet eviction thresholds to prevent resource exhaustion
      - arg: "--kubelet-arg=eviction-hard=imagefs.available<1%,nodefs.available<1%"
        nodeFilters:
          - server:*
      - arg: "--kubelet-arg=eviction-minimum-reclaim=imagefs.available=1%,nodefs.available=1%"
        nodeFilters:
          - server:*
      # Disable Traefik to avoid conflicts with OpenChoreo Gateway controller
      - arg: "--disable=traefik"
        nodeFilters:
          - server:*

# Configure insecure registries for HTTP access
# Allows kubelet to pull images from Build Plane registry via HTTP
registries:
  config: |
    mirrors:
      "host.k3d.internal:10082":
        endpoint:
          - http://host.k3d.internal:10082
