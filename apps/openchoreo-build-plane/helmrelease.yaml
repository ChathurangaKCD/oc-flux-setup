---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openchoreo-build-plane
  namespace: openchoreo-build-plane
spec:
  interval: 5m
  dependsOn:
    - name: openchoreo-control-plane
      namespace: openchoreo-control-plane
  chart:
    spec:
      chart: openchoreo-build-plane
      version: "0.11.0"
      sourceRef:
        kind: HelmRepository
        name: openchoreo
        namespace: flux-system
      interval: 12h
  install:
    # Retry on CRD timing issues (Argo CRDs installed by chart dependencies)
    remediation:
      retries: 3
      remediateLastFailure: true
  upgrade:
    remediation:
      retries: 3
  values:
    argo-workflows:
      server:
        # Argo Workflows UI is enabled for testing/development purposes
        enabled: true
        serviceType: LoadBalancer
        servicePort: 2746
        authModes:
          - server
    # Container Registry configuration for single-cluster
    registry:
      service:
        type: LoadBalancer
        port: 5000
    # All components access via host.k3d.internal:10082
    global:
      defaultResources:
        registry:
          endpoint: "host.k3d.internal:10082"
    # Disable External Secrets since it's already in the Data Plane (single cluster)
    external-secrets:
      enabled: false
    # Disable Fluent Bit for Build Plane in single-cluster mode
    fluent-bit:
      enabled: false
